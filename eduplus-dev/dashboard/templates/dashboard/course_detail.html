{% extends "base.html" %}
{% load static %}

{% block title %}{{ course.title }} | Détails du Cours | EduPlus{% endblock %}

{% block extra_css %}
<style>
    .dashboard-header {
        background-color: var(--primary-color);
        padding: 2rem 0;
        margin-bottom: 2rem;
        color: white;
    }
    .course-image {
        width: 100%;
        height: 300px;
        object-fit: cover;
        border-radius: 10px;
    }
    .stat-card {
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        padding: 1.5rem;
        transition: transform 0.3s ease;
        height: 100%;
    }
    .stat-icon {
        font-size: 2rem;
        margin-bottom: 1rem;
        display: inline-block;
        width: 60px;
        height: 60px;
        line-height: 60px;
        text-align: center;
        border-radius: 50%;
    }
    .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
    }
    .sidebar-nav {
        position: sticky;
        top: 90px;
    }
    .sidebar-link {
        display: flex;
        align-items: center;
        padding: 0.75rem 1rem;
        color: var(--dark-color);
        text-decoration: none;
        border-radius: 5px;
        margin-bottom: 0.5rem;
        transition: all 0.2s ease;
    }
    .sidebar-link:hover, .sidebar-link.active {
        background-color: var(--primary-color);
        color: white;
    }
    .sidebar-link i {
        margin-right: 0.75rem;
        width: 20px;
        text-align: center;
    }
</style>
{% endblock %}

{% block content %}
<!-- En-tête -->
<section class="dashboard-header">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-lg-8">
                <h1 class="mb-2">{{ course.title }}</h1>
                <p class="lead mb-0">Détails du cours</p>
            </div>
            <div class="col-lg-4 text-lg-end">
                <a href="{% url 'dashboard:courses_management' %}" class="btn btn-light me-2">
                    <i class="fas fa-arrow-left me-1"></i> Retour
                </a>
                <a href="{% url 'dashboard:course_edit' course.id %}" class="btn btn-primary me-2">
                    <i class="fas fa-edit me-1"></i> Modifier
                </a>
                <a href="{% url 'dashboard:course_delete' course.id %}" class="btn btn-danger">
                    <i class="fas fa-trash me-1"></i> Supprimer
                </a>
            </div>
        </div>
    </div>
</section>

<div class="container mb-5">
    <div class="row">
        <!-- Sidebar de navigation -->
        <div class="col-lg-3 mb-4">
            <div class="sidebar-nav">
                <a href="{% url 'dashboard:admin' %}" class="sidebar-link">
                    <i class="fas fa-home"></i> Tableau de bord
                </a>
                <a href="{% url 'dashboard:users' %}" class="sidebar-link">
                    <i class="fas fa-users"></i> Utilisateurs
                </a>
                <a href="{% url 'dashboard:courses_management' %}" class="sidebar-link active">
                    <i class="fas fa-chalkboard"></i> Cours
                </a>
                <a href="{% url 'dashboard:instructors' %}" class="sidebar-link">
                    <i class="fas fa-chalkboard-teacher"></i> Instructeurs
                </a>
                <a href="{% url 'dashboard:students' %}" class="sidebar-link">
                    <i class="fas fa-user-graduate"></i> Étudiants
                </a>
                <a href="{% url 'dashboard:transactions' %}" class="sidebar-link">
                    <i class="fas fa-money-bill-wave"></i> Transactions
                </a>
                <a href="{% url 'dashboard:reports_management' %}" class="sidebar-link">
                    <i class="fas fa-chart-line"></i> Rapports
                </a>
                <a href="{% url 'dashboard:settings' %}" class="sidebar-link">
                    <i class="fas fa-cog"></i> Paramètres
                </a>
                <a href="{% url 'dashboard:notifications' %}" class="sidebar-link">
                    <i class="fas fa-bell"></i> Notifications
                </a>
            </div>
        </div>
        
        <!-- Contenu principal -->
        <div class="col-lg-9">
            <div class="row mb-4">
                <div class="col-md-4 mb-3">
                    <div class="stat-card">
                        <div class="d-flex align-items-center mb-3">
                            <div class="stat-icon bg-primary-subtle text-primary me-3">
                                <i class="fas fa-users"></i>
                            </div>
                            <h4 class="h5 mb-0">Étudiants</h4>
                        </div>
                        <h2 class="mb-0">{{ total_students }}</h2>
                        <p class="text-muted mb-0">Inscrits</p>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="stat-card">
                        <div class="d-flex align-items-center mb-3">
                            <div class="stat-icon bg-success-subtle text-success me-3">
                                <i class="fas fa-star"></i>
                            </div>
                            <h4 class="h5 mb-0">Évaluation</h4>
                        </div>
                        <h2 class="mb-0">{{ average_rating|floatformat:1 }}</h2>
                        <p class="text-muted mb-0">Sur 5 étoiles</p>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="stat-card">
                        <div class="d-flex align-items-center mb-3">
                            <div class="stat-icon bg-warning-subtle text-warning me-3">
                                <i class="fas fa-comments"></i>
                            </div>
                            <h4 class="h5 mb-0">Avis</h4>
                        </div>
                        <h2 class="mb-0">{{ total_reviews }}</h2>
                        <p class="text-muted mb-0">Commentaires</p>
                    </div>
                </div>
            </div>
            
            <!-- Informations du cours -->
            <div class="card mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Informations du cours</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-5 mb-4">
                            {% if course.image %}
                                <img src="{{ course.image.url }}" class="course-image" alt="{{ course.title }}">
                            {% else %}
                                <img src="{% static 'img/default-course.png' %}" class="course-image" alt="{{ course.title }}">
                            {% endif %}
                        </div>
                        <div class="col-md-7">
                            <h4 class="mb-3">{{ course.title }}</h4>
                            <p><strong>Instructeur :</strong> {{ course.instructor.get_full_name|default:course.instructor.username }}</p>
                            <p><strong>Catégorie :</strong> {{ course.category.name }}</p>
                            <p><strong>Prix :</strong> {{ course.price }} €</p>
                            <p><strong>Date de création :</strong> {{ course.created_at|date:"d/m/Y" }}</p>
                            <p><strong>Dernière mise à jour :</strong> {{ course.updated_at|date:"d/m/Y" }}</p>
                            <p><strong>Statut :</strong> 
                                {% if course.is_published %}
                                    <span class="badge bg-success">Publié</span>
                                {% else %}
                                    <span class="badge bg-warning">Non publié</span>
                                {% endif %}
                            </p>
                            <p><strong>Difficulté :</strong> {{ course.get_difficulty_level_display }}</p>
                            <p><strong>Langue :</strong> {{ course.language }}</p>
                        </div>
                    </div>
                    
                    <div class="row mt-4">
                        <div class="col-12">
                            <h5>Description</h5>
                            <p>{{ course.overview|linebreaks }}</p>
                            
                            {% if course.objectives %}
                            <h5>Objectifs</h5>
                            <p>{{ course.objectives|linebreaks }}</p>
                            {% endif %}
                            
                            {% if course.requirements %}
                            <h5>Prérequis</h5>
                            <p>{{ course.requirements|linebreaks }}</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Liste des modules -->
            <div class="card mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Modules du cours</h5>
                </div>
                <div class="card-body">
                    {% if course.modules.all %}
                        <div class="accordion" id="moduleAccordion">
                            {% for module in course.modules.all %}
                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#module{{ module.id }}" aria-expanded="false" aria-controls="module{{ module.id }}">
                                            {{ module.title }}
                                        </button>
                                    </h2>
                                    <div id="module{{ module.id }}" class="accordion-collapse collapse" data-bs-parent="#moduleAccordion">
                                        <div class="accordion-body">
                                            <p>{{ module.description }}</p>
                                            <ul class="list-group">
                                                {% for content in module.contents.all %}
                                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                                        <div>
                                                            <i class="fas 
                                                                {% if content.content_type == 'text' %}fa-file-alt
                                                                {% elif content.content_type == 'video' %}fa-video
                                                                {% elif content.content_type == 'file' %}fa-file
                                                                {% elif content.content_type == 'image' %}fa-image
                                                                {% else %}fa-link{% endif %} 
                                                                me-2"></i>
                                                            {{ content.title }}
                                                        </div>
                                                        {% if content.is_free %}
                                                            <span class="badge bg-success">Gratuit</span>
                                                        {% endif %}
                                                    </li>
                                                {% empty %}
                                                    <li class="list-group-item text-center">Aucun contenu dans ce module</li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-center py-3">Aucun module n'a été créé pour ce cours.</p>
                    {% endif %}
                </div>
            </div>
            
            <!-- Liste des étudiants inscrits -->
            <div class="card mb-4">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Étudiants inscrits</h5>
                    <span class="badge bg-primary">{{ total_students }}</span>
                </div>
                <div class="card-body">
                    {% if enrollments %}
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th>Étudiant</th>
                                        <th>Date d'inscription</th>
                                        <th>Statut</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for enrollment in enrollments %}
                                        <tr>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    {% if enrollment.student.profile_picture %}
                                                        <img src="{{ enrollment.student.profile_picture.url }}" alt="{{ enrollment.student.username }}" class="user-avatar me-2">
                                                    {% else %}
                                                        <img src="{% static 'img/default-user.png' %}" alt="{{ enrollment.student.username }}" class="user-avatar me-2">
                                                    {% endif %}
                                                    <span>{{ enrollment.student.get_full_name|default:enrollment.student.username }}</span>
                                                </div>
                                            </td>
                                            <td>{{ enrollment.enrolled_at|date:"d/m/Y" }}</td>
                                            <td>
                                                {% if enrollment.completed %}
                                                    <span class="badge bg-success">Terminé</span>
                                                {% elif enrollment.active %}
                                                    <span class="badge bg-primary">Actif</span>
                                                {% else %}
                                                    <span class="badge bg-secondary">Inactif</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <a href="{% url 'dashboard:student_detail' enrollment.student.id %}" class="btn btn-sm btn-outline-secondary">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% if total_students > 10 %}
                            <div class="text-center mt-3">
                                <a href="#" class="btn btn-outline-primary">Voir tous les étudiants ({{ total_students }})</a>
                            </div>
                        {% endif %}
                    {% else %}
                        <p class="text-center py-3">Aucun étudiant n'est inscrit à ce cours.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %} 